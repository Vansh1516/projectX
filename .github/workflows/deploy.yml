name: Deploy to Home Lab (Docker)

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # ---------------------------------------------------------
      # 1. Build the Docker Image
      # We tag (-t) the image as 'vansh-server'
      # ---------------------------------------------------------
      - name: Build Docker Image
        run: docker build -t vansh-server .

      # ---------------------------------------------------------
      # 2. Stop Old Container (if running)
      # We look for a container named 'vansh-container'
      # ---------------------------------------------------------
      - name: Stop Old Container
        run: |
          docker stop vansh-container || true
          docker rm vansh-container || true

      # ---------------------------------------------------------
      # 3. Run New Container
      # We start a new container named 'vansh-container'
      # using the image 'vansh-server' we built in Step 1
      # ---------------------------------------------------------
      - name: Run New Container
        run: |
          docker run -d \
            --name vansh-container \
            --restart always \
            -p 80:80 \
            vansh-server